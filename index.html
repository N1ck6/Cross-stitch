<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <title>Listener</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      font-family: 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #bbdefb, #e1bee7);
      color: #424242;
      height: 100vh;
      padding-bottom: 20px;
      line-height: 0.1;
    }
    .main-container {
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .hero {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('https://crosti.ru/artworks/00/00/fa/72_picture_5dd91a4c.jpg') no-repeat center center/cover;
      opacity: 0.2;
      z-index: 0;
    }
    .hero-content {
      position: relative;
      z-index: 1;
      width: 100%;
    }
    .hero h1 {
      font-size: 2.2rem;
      margin-bottom: 20px;
      color: #37474f;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .hero p {
      font-size: 1.1rem;
      margin-bottom: 30px;
      color: #546e7a;
      line-height: 1.5;
    }
    .load-btn {
      background: linear-gradient(to right, #4fc3f7, #29b6f6);
      color: white;
      border: none;
      padding: 16px 35px;
      border-radius: 50px;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(41, 182, 246, 0.3);
      transition: all 0.3s ease;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }
    .load-btn::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -60%;
      width: 20px;
      height: 200%;
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(30deg);
      transition: all 0.8s;
    }
    .load-btn:active {
      transform: scale(0.97);
      box-shadow: 0 2px 8px rgba(41, 182, 246, 0.3);
    }
    .load-btn:hover::after {
      left: 120%;
    }
    
    .controls {
      display: flex;
      position: sticky;
      top: 10px;
      justify-content: space-between;
      align-items: center;
      margin: 10px;
      padding: 10px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: max-content;
      align-self: center;
      gap: 15px;
      flex-direction: column;
      z-index: 10;
    }
    .progress-container {
      position: absolute;
      bottom: 0;
      left: 2%;
      width: 96%;
      height: 1px;
      background: white;
    }

    .progress-bar {
      height: 100%;
      background: #4CAF50;
      width: 0%;
      transition: width 0.3s ease;
    }
    .page-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }
    
    .page-selector label {
      margin-right: 10px;
      font-weight: 500;
      background-color: #fefefe;
    }
    
    .page-input {
      width: 60px;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      font-size: 1.2rem;
    }
    
    .nav-btn {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      color: #0b406e;
      border: none;
      padding: 7px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .nav-btn:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }
    
    .results {
      display: none;
      height: max-content;
      margin: auto 8px;
    }
    
    .content-box {
      border: 2px solid rgb(255, 248, 223);
      padding: 10px;
      background-color: #fefefe;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .content-box pre {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      background-color: #e6e6e6;
      border-radius: 5px;
    }
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 20px;
    }
    .spinner {
      width: 45px;
      height: 45px;
      border: 4px solid rgba(79, 195, 247, 0.3);
      border-top: 4px solid #4fc3f7;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 15px;
    }
    .loading p {
      color: #546e7a;
      font-size: 1.05rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .page-selector {
        align-items: flex-start;
      }
      
      .page-selector label {
        margin-bottom: 5px;
      }
    }

    .other {
      opacity: 0.15;
      transform: scale(0.9);
    }
    .letter {
      position: relative;
      display: inline-block;
      width: 1.2%;
      aspect-ratio: 1/1;
      text-align: center;
      font-size: 0.7rem;
    }
    .letter.show-dot {
      border: 1px solid #000000;
    }
    .letter.show-dot::before,
    .letter.show-dot::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 35%;
      aspect-ratio: 5/1;
      background-color: #FFFFFF;
      border: 1px solid #000000;
      transform-origin: center;
      pointer-events: none;
    }
    .letter.show-dot::before {
      transform: translate(-50%, -50%) rotate(90deg);
    }
    .letter.show-dot::after {
      transform: translate(-50%, -50%);
    }
    .letter.show-dot.crossed::before {
      transform: translate(-50%, -50%) rotate(45deg);
    }
    .letter.show-dot.crossed::after {
      transform: translate(-50%, -50%) rotate(-45deg);
    }
    #tableContent {
      position: relative;
    }
    .grid-line {
      position: absolute;
      background: black;
      z-index: 2;
      pointer-events: none;
    }

    .vertical {
      width: 1px;
      height: 100%;
      top: 0;
    }

    .horizontal {
      height: 1px;
      width: 100%;
      left: 0;
    }
    .crossed {
        -webkit-mask-size: cover;
        mask-size: cover;
        -webkit-mask-image: url(marked.svg);
        mask-image: url(marked.svg);
    }
    .crossbtn {
      transition: all 0.6s;
      font-weight: 1000;
      padding: 8px 12px;
    }
    .crossbtn.toggled {
      background: linear-gradient(135deg, #ff9800, #d4af37);
      color: #000;
    } 
    .crossbtn.toggledAll {
      background: linear-gradient(135deg, #f2743a, #e4682e);
      color: #000;
    } 
    .crossbtn:active {
        transform: translateY(3px);
    }
    .ncolor {
        user-select: none;
    }
    .arrow svg {
        width: 20px;
        height: auto;
        cursor: pointer;
        overflow: visible;
    }
    .arrow svg polygon, 
    .arrow svg path {
        transition: all 0.2s cubic-bezier(0.2, 1, 0.3, 1);
        fill: #0b406e;
    }
    .arrow:active polygon, 
    .arrow:active path {
        fill: #0b406e;
    }
    .arrow:active .arrow-6-pl {
        animation: arrow-anim 1s cubic-bezier(0.2, 1, 0.3, 1);
    }
    .arrow:active .arrow-6-pl-fixed {
        animation: arrow-fixed-anim 1s cubic-bezier(0.2, 1, 0.3, 1);
    }

    @keyframes arrow-anim {
        0% {
            opacity: 1;
            transform: translateX(0);
        }
        5% {
            transform: translateX(-0.1rem);
        }
        100% {
            transform: translateX(1rem);
            opacity: 0;
        }
    }
    @keyframes arrow-fixed-anim {
        5% {
            opacity: 0;
        }
        20% {
            opacity: 0.4;
        }
        100% {
            opacity: 1;
        }
    }
    
    .unselect {
        padding: 3px 8px;
        font-size: 1.5rem;
        transition: all 0.2s ease-out;
    }
    
    .unselect:active {
        animation: unselect-anim 0.2s ease;
    }
    
    .unselect .text {
        display: inline-block;
        transform-origin: center;
        transition: transform 0.1s ease;
    }    

    @keyframes textRotate {
        0% { transform: rotate(0deg);
            color: #0b406e;
        }
        99% { transform: rotate(-360deg);
            color: #c30000;
        }
        100% { transform: rotate(-360deg);
            color: #0b406e;
        }
    }

    .unselect.animate .text {
        animation: textRotate 1s ease-in-out forwards;
    }
    @media (orientation: landscape) {
      body {
        min-height: 100vw;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="hero" id="heroSection">
      <div class="hero-content">
        <h1>Listener</h1>
        <p>Погрузись в мир спокойствия и гармонии с удобным приложением для вышивки</p>
        <button class="load-btn" id="loadBtn">Загрузить страницу</button>
      </div>
    </div>
    <div class="controls" id="controls" style="display: none;">
      <div class="page-selector">
        <button class="nav-btn arrow" id="prevBtn">
            <svg width="18px" height="17px" viewBox="0 0 18 17" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <g transform="translate(8.500000, 8.500000) scale(-1, 1) translate(-8.500000, -8.500000)">
            <polygon class="arrow-6-pl" points="16.3746667 8.33860465 7.76133333 15.3067621 6.904 14.3175671 14.2906667 8.34246869 6.908 2.42790698 7.76 1.43613596"></polygon>
            <polygon class="arrow-6-pl-fixed" points="16.3746667 8.33860465 7.76133333 15.3067621 6.904 14.3175671 14.2906667 8.34246869 6.908 2.42790698 7.76 1.43613596"></polygon>
            <path d="M-1.48029737e-15,0.56157424 L-1.48029737e-15,16.1929159 L9.708,8.33860465 L-2.66453526e-15,0.56157424 L-1.48029737e-15,0.56157424 Z M1.33333333,3.30246869 L7.62533333,8.34246869 L1.33333333,13.4327013 L1.33333333,3.30246869 L1.33333333,3.30246869 Z"></path>
        </g>
    </svg>
        </button>
        <input id="pageInput" class="page-input" min="1" value="1">
        <button class="nav-btn arrow" id="nextBtn">
            <svg width="18px" height="17px" viewBox="-1 0 18 17" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <g>
            <polygon class="arrow-6-pl" points="16.3746667 8.33860465 7.76133333 15.3067621 6.904 14.3175671 14.2906667 8.34246869 6.908 2.42790698 7.76 1.43613596"></polygon>
            <polygon class="arrow-6-pl-fixed" points="16.3746667 8.33860465 7.76133333 15.3067621 6.904 14.3175671 14.2906667 8.34246869 6.908 2.42790698 7.76 1.43613596"></polygon>
            <path d="M-4.58892184e-16,0.56157424 L-4.58892184e-16,16.1929159 L9.708,8.33860465 L-1.64313008e-15,0.56157424 L-4.58892184e-16,0.56157424 Z M1.33333333,3.30246869 L7.62533333,8.34246869 L1.33333333,13.4327013 L1.33333333,3.30246869 L1.33333333,3.30246869 Z"></path>
        </g>
        </svg></button>
        <input id="ncolor" disabled class="page-input ncolor" value="">
        <button class="nav-btn crossbtn" id="cross"><b>╳</button>
        <button class="nav-btn unselect" id="unselect" onclick=resetSelection()><span class="text" id="span-header">↺</b></span></button>
      </div>
      <div class="progress-container">
        <div class="progress-bar"></div>
      </div>
    </div>
    <div class="results" id="results">
      <div class="content-box">
        <pre id="tableContent"></pre>
      </div>
    </div>
    <div class="loading" id="loadingIndicator" style="display: none;">
      <div class="spinner"></div>
      <p>Загрузка документа...</p>
    </div>
  </div>
  <script>
    const appContainer = document.getElementById('appContainer');
    const heroSection = document.getElementById('heroSection');
    const loadBtn = document.getElementById('loadBtn');
    const crossBtn = document.getElementById('cross');
    const unselectBtn = document.getElementById('unselect');
    const controls = document.getElementById('controls');
    const results = document.getElementById('results');
    const pageInput = document.getElementById('pageInput');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfo = document.getElementById('pageInfo');
    const tableContent = document.getElementById('tableContent');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const ncolor = document.getElementById('ncolor');
    let currentPage = 1;
    let totalPages = 30;
    let isDataLoaded = false;
    let isToggled = false;
    let isToggledAll = false;
    let lastColor = null;
    let Keys = {};
    let Data = {};
    let i, j, p;
    let leftP = [2, 3, 4, 5, 6];
    let topP = [7, 13, 19, 25];
    let bothP = [8, 9, 10, 11, 12, 14, 15, 16, 17, 18, 20, 21, 22, 23, 24, 26, 27, 28, 29, 30];
    let offsetL = [0, 7, 4, 1, 8, 5]; // ends with 5
    let offsetT = [0, 5]; // 3x by 5x 0, 5x 5
    let allSquares;
    let doneSquares;

    
    function savePageToCookie(page) {
      document.cookie = `currentPage=${page}; path=/; max-age=31536000`;
    }
    
    function getPageFromCookie() {
      const name = "currentPage=";
      const decodedCookie = decodeURIComponent(document.cookie);
      const ca = decodedCookie.split(';');
      for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) === 0) {
          return parseInt(c.substring(name.length, c.length));
        }
      }
      return null;
    }
    
    function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i].trim();
        if (c.startsWith(nameEQ)) return c.substring(nameEQ.length);
    }
    return null;
    }

    function migrateOldData() {
      const oldCookie = getCookie('dataStore');
      if (!oldCookie) return;
      try {
          const oldData = JSON.parse(oldCookie);
          const specialPages = [6, 12, 18, 24, 30];
          
          for (const pageStr in oldData) {
              const page = parseInt(pageStr, 10);
              if (isNaN(page) || page < 1 || page > 30) continue;
              
              const pairs = oldData[pageStr];
              const cellsPerRow = specialPages.includes(page) ? 65 : 80;
              const cellNumbers = pairs.map(pair => 
                  pair[0] * cellsPerRow + pair[1]
              );
              localStorage.setItem(`dataStore_page${page}`, JSON.stringify(cellNumbers));
          }
          document.cookie = "dataStore=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Strict";
      } catch (e) {
          document.cookie = "dataStore=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Strict";
      }
    }
    migrateOldData();

    function addPairToKey(key, i, j) {
        const specialPages = [6, 12, 18, 24, 30];
        const cellsPerRow = specialPages.includes(key) ? 65 : 80;
        const cellNumber = i * cellsPerRow + j;
        const storageKey = `dataStore_page${key}`;
        let cellNumbers = [];
        const storedData = localStorage.getItem(storageKey);
        if (storedData) {
            try {
                cellNumbers = JSON.parse(storedData);
            } catch (e) {
                cellNumbers = [];
            }
        }
        
        if (!cellNumbers.includes(cellNumber)) {
            cellNumbers.push(cellNumber);
            localStorage.setItem(storageKey, JSON.stringify(cellNumbers));
        }
    }

    function deletePairFromKey(key, i, j) {
      const specialPages = [6, 12, 18, 24, 30];
      const cellsPerRow = specialPages.includes(key) ? 65 : 80;
      const cellNumber = i * cellsPerRow + j;
      const storageKey = `dataStore_page${key}`;
      const storedData = localStorage.getItem(storageKey);
      if (!storedData) return;
      try {
          let cellNumbers = JSON.parse(storedData);
          const index = cellNumbers.indexOf(cellNumber);
          if (index !== -1) {
              cellNumbers.splice(index, 1);
              localStorage.setItem(storageKey, JSON.stringify(cellNumbers));
          }
      } catch (e) {
          localStorage.removeItem(storageKey);
      }
    }

    function getPairsForKey(key) {
      const specialPages = [6, 12, 18, 24, 30];
      const cellsPerRow = specialPages.includes(key) ? 65 : 80;
      const storageKey = `dataStore_page${key}`;
      const storedData = localStorage.getItem(storageKey);
      if (!storedData) return [];
      try {
          const cellNumbers = JSON.parse(storedData);
          return cellNumbers.map(num => [Math.floor(num / cellsPerRow), num % cellsPerRow]);
      } catch (e) {
          localStorage.removeItem(storageKey);
          return [];
      }
    }

    function setProgress(percent) {
      const progressBar = document.querySelector('.progress-bar');
      progressBar.style.width = Math.min(100, Math.max(0, percent*100)) + '%';
    }
    document.addEventListener('DOMContentLoaded', () => {
      loadBtn.addEventListener('click', () => {
        setTimeout(() => {
          heroSection.style.display = 'none';
          controls.style.display = 'flex';
          renderPage(currentPage);
        }, 450);
      });
      crossBtn.addEventListener('click', () => {
        if (!isToggled && !isToggledAll) {
          isToggled = !isToggled;
          crossBtn.classList.toggle('toggled');
        } else if (isToggled && !isToggledAll) {
          isToggled = !isToggled;
          isToggledAll = !isToggledAll;
          crossBtn.classList.toggle('toggled');
          crossBtn.classList.toggle('toggledAll');
        } else if (isToggledAll) {
          isToggledAll = !isToggledAll;
          crossBtn.classList.toggle('toggledAll');
        }
      });
      unselectBtn.addEventListener('click', function() {
            this.classList.remove('animate');
            void this.offsetWidth;
            this.classList.add('animate');
        });
      prevBtn.addEventListener('click', goToPrevPage);
      nextBtn.addEventListener('click', goToNextPage);
      pageInput.addEventListener('change', goToPage);
    });
    

    function loadData() {
      showLoading(true);
      Promise.all([
        fetch('keys.json').then(res => res.json()),
        fetch('data.json').then(res => res.json())
      ]).then(([keysData, dataData]) => {
        Keys = keysData;
        Data = dataData;
        isDataLoaded = true;
        
        const savedPage = getPageFromCookie();
        if (savedPage && savedPage <= totalPages) {
          currentPage = savedPage;
          pageInput.value = currentPage;
        }
        showLoading(false);
      })
    }
    loadData();

    function MoreGray(hex, amount = 1) {
        const [r, g, b] = hex.match(/\w\w/g).map(x => parseInt(x, 16) / 255);
        const max = Math.max(r, g, b), min = Math.min(r, g, b);
        const l = (max + min) / 2;
        const diff = max - min;
        const s = diff && (l > 0.5 ? diff / (2 - max - min) : diff / (max + min));
        const ns = s * (1 - amount);
        const q = l <= 0.5 ? l * (1 + ns) : l + ns - l * ns;
        const p = 2 * l - q;
        const h = max === r ? (g - b) / diff / 6 : max === g ? (b - r) / diff / 6 + 1/3 : (r - g) / diff / 6 + 2/3;

        const hue2rgb = (p, q, t) => {
            if (t < 0) t += 1;
            if (t > 1) t -= 1;
            return t < 1/6 ? p + (q - p) * 6 * t : t < 1/2 ? q : t < 2/3 ? p + (q - p) * (2/3 - t) * 6 : p;
        };

        const toHex = x => Math.round(x * 255).toString(16).padStart(2, '0');
        return `#${[hue2rgb(p, q, h + 1/3), hue2rgb(p, q, h), hue2rgb(p, q, h - 1/3)].map(toHex).join('')}`;
        }

    function renderPage(num) {
      if (!isDataLoaded) return;
      currentPage = num;
      pageInput.value = currentPage;
      savePageToCookie(currentPage);
      updatePageControls();
      displayTable(Data[String(num)]);
    }

    function displayTable(lines) {
      results.style.display = "block";
      controls.style.display = "flex";
      tableContent.replaceChildren();
      let i = 0;
      let j = 0;
      let off1 = offsetT[Math.floor((currentPage - 1)/6) % 2];
      let off2 = offsetL[(currentPage - 1)%6];
      let lines1 = 0;
      let lines2 = 0;
      allSquares = 0;
      doneSquares = 0;
      let one = document.getElementById('tableContent').offsetWidth * 0.012;
      let oneHeight = document.getElementById('tableContent').offsetHeight;
      const crossed = getPairsForKey(currentPage);
      lines.forEach(row => {
        row.forEach(elem => {
          var letterElem = document.createElement('span');
          letterElem.setAttribute('class', 'letter');
          if (crossed.some(pair => pair[0] === i && pair[1] === j)) {
            letterElem.classList.toggle("crossed")
            doneSquares++;
          }
          if ((0 <= j && j <= 2 && leftP.includes(currentPage)) ||
              (0 <= i && i <= 2 && topP.includes(currentPage)) ||
              ((0 <= i && i <= 2 || 0 <= j && j <= 2) && bothP.includes(currentPage))) {
            letterElem.style.background = MoreGray(Keys[elem]);
            letterElem.color = MoreGray(Keys[elem]);
          }
          else {
            letterElem.style.background = Keys[elem];
            letterElem.color = Keys[elem];
          }
          if ((i+off1)%10 == 0 && i != 0 && j == 0){
            if (j==0){
              var line = document.createElement('div');
              line.className = 'grid-line horizontal';
              line.style.top = (i*one + lines1)/oneHeight*100 + '%';
              tableContent.appendChild(line);
            }
            letterElem.style.marginTop = '1px';
            lines1++;
          } 
          if ((j+off2)%10 == 0 && j != 0){
            if (i==0){
              var line = document.createElement('div');
              line.className = 'grid-line vertical';
              line.style.left = `calc(${j*1.2}% + ${lines2}px)`;
              tableContent.appendChild(line);
            }
            letterElem.style.marginLeft = '1px';
            lines2++;
          } 
          letterElem.num = elem;
          letterElem.data = [i, j]
          letterElem.addEventListener('click', () => chooseColor(letterElem));
          tableContent.appendChild(letterElem);
          j++;
          allSquares++;
        });
        i++;
        j = 0;
        tableContent.appendChild(document.createElement('br'));
      });    
      if (lastColor != null) chooseColor(lastColor, 1);
      setProgress(doneSquares/allSquares);
    }

    function chooseColor(elem, mode=0) {
      if (mode == 0) color = elem.color;
      else color = elem;
      if (mode == 0 && isToggled && lastColor != null) {
        if (lastColor == color) {
            [i, j] = elem.data;
            if (elem.classList.contains("crossed")) {
                deletePairFromKey(currentPage, i, j);
                doneSquares--;
              }
            else {
                addPairToKey(currentPage, i, j);
                doneSquares++;
              }
            elem.classList.toggle("crossed");
            setProgress(doneSquares/allSquares);
        }
      } else if (mode == 0 && isToggledAll && lastColor != null) {
        const specialPages = [6, 12, 18, 24, 30];
        const cellsPerRow = specialPages.includes(currentPage) ? 65 : 80;
        const cellNumber = i * cellsPerRow + j;
        const storageKey = `dataStore_page${currentPage}`;
        let cellNumbers = [];
        const storedData = localStorage.getItem(storageKey);
        if (storedData) {
            try {
                cellNumbers = JSON.parse(storedData);
            } catch (e) {
                cellNumbers = [];
            }
        }

        if (lastColor == color) {
          if (!elem.classList.contains("crossed")) {
            document.querySelectorAll('span').forEach(span => {
              if (span.color == lastColor && span.id != "span-header" && !span.classList.contains("crossed")) {
                span.classList.add("crossed");
                [i, j] = span.data;

                const cellNumber = i * cellsPerRow + j;
                if (!cellNumbers.includes(cellNumber)) cellNumbers.push(cellNumber);
                doneSquares++;
              }
            })
          } else {
            document.querySelectorAll('span').forEach(span => {
              if (span.color == lastColor && span.id != "span-header" && span.classList.contains("crossed")) {
                span.classList.remove("crossed");
                [i, j] = span.data;

                const cellNumber = i * cellsPerRow + j;
                const index = cellNumbers.indexOf(cellNumber);
                if (index !== -1) cellNumbers.splice(index, 1);
                doneSquares--;
              }
            })

          }
        }
        localStorage.setItem(storageKey, JSON.stringify(cellNumbers));
        setProgress(doneSquares/allSquares);
      } else {
        if (mode == 0) {
          if (color == lastColor) return;
          num = elem.num
          lastColor = color;
          ncolor.value = num;
        }
        document.querySelectorAll('span').forEach(span => {
            if (span.color != color && span.id != "span-header") {
              span.classList.add('other');
              span.classList.remove('show-dot');
            }
            else if (span.classList.contains('other')) {
              span.classList.remove('other');
            }
            if (span.color == color && span.id != "span-header") span.classList.add('show-dot');
        })
      }
    }

    
    function resetSelection() {
      document.querySelectorAll('span').forEach(span => {
        if (span.classList.contains('other')) span.classList.remove('other');
        if (span.classList.contains('show-dot')) span.classList.remove('show-dot');
      })
      lastColor = null;
      ncolor.value = "";
    }

    function updatePageControls() {
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
    }
    
    function goToPrevPage() {
      if (currentPage > 1) {
        renderPage(currentPage - 1);
      }
    }
    
    function goToNextPage() {
      if (currentPage < totalPages) {
        renderPage(currentPage + 1);
      }
    }
    
    function goToPage() {
      const pageNum = parseInt(pageInput.value);
      if (pageNum >= 1 && pageNum <= totalPages) {
        renderPage(pageNum);
      } else 
        pageInput.value = currentPage;
    }
    
    function showLoading(show) {
      loadingIndicator.style.display = show ? 'flex' : 'none';
      heroSection.style.display = show ? 'none' : 'flex';
    }
  </script>
</body>
</html>
